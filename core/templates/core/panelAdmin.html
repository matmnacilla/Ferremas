<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administrador - Ferremas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #343a40;
      color: white;
      padding: 20px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px 0;
    }
    .sidebar a:hover {
      background-color: #495057;
      border-radius: 5px;
    }
    .content {
      flex-grow: 1;
      padding: 40px;
      background-color: #f8f9fa;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    :root {
      --primary-color: #0d6efd;
      --sidebar-bg: #343a40;
      --sidebar-hover: #495057;
    }
    
    .sidebar {
      background-color: var(--sidebar-bg);
    }
    
    .sidebar a:hover {
      background-color: var(--sidebar-hover);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
    }
    
    .table-hover tbody tr:hover {
      background-color: rgba(13, 110, 253, 0.05);
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h4>Admin - Ferremas</h4>
    <hr>
    <a href="#" onclick="showSection('dashboard')">üìä Dashboard</a>
    <a href="#" onclick="showSection('productos')">üì¶ Gesti√≥n de Productos</a>
    <a href="#" onclick="showSection('ofertas')">üè∑Ô∏è Gesti√≥n de Ofertas</a>
    <a href="#" onclick="showSection('empleados')">üë• Gesti√≥n de Empleados</a>
    <a href="#" onclick="showSection('ventas')">üìà Informe de Ventas</a>
    <a href="#" onclick="showSection('desempeno')">üìä Desempe√±o Tienda</a>
    <a href="#" onclick="showSection('pedidos')">üìë Pedidos</a>
    <hr>
    <a href="#" onclick="confirmarLogout()" style="color: #dc3545;">
      <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
    </a>
  </div>

  <div class="content">
    <!-- Mensaje de error si existe -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <strong>Error:</strong> {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- Dashboard Section -->
    <div id="dashboard" class="section active">
      <!-- Las tarjetas de resumen existentes se mantienen aqu√≠ -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">Total Productos</h5>
              <h2 class="card-text">{{ total_productos }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">Stock Bajo</h5>
              <h2 class="card-text">{{ productos_stock_bajo }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">En Oferta</h5>
              <h2 class="card-text">{{ productos_oferta }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">Productos Activos</h5>
              <h2 class="card-text">{{ productos_activos }}</h2>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card bg-secondary text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">Total Ventas</h5>
              <h2 class="card-text">{{ total_ventas }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-dark text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">Ventas este mes</h5>
              <h2 class="card-text">{{ ventas_mes }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-primary text-white mb-3">
            <div class="card-body">
              <h5 class="card-title">Empleados Activos</h5>
              <h2 class="card-text">{{ empleados_activos }}</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Gesti√≥n de Productos -->
    <div id="productos" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gesti√≥n de Productos</h2>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNuevoProducto">
          <i class="bi bi-plus-circle"></i> Nuevo Producto
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Precio</th>
              <th>Stock</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for producto in productos %}
            <tr>
              <td>{{ producto.id }}</td>
              <td>
                {% if producto.imagen %}
                  <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" style="width: 50px; height: 50px; object-fit: cover;">
                {% else %}
                  <i class="bi bi-image text-muted"></i>
                {% endif %}
              </td>
              <td>{{ producto.nombre }}</td>
              <td>{{ producto.categoria }}</td>
              <td>${{ producto.precio }}</td>
              <td>{{ producto.stock }}</td>
              <td>
                {% if producto.activo %}
                  <span class="badge bg-success">Activo</span>
                {% else %}
                  <span class="badge bg-danger">Inactivo</span>
                {% endif %}
              </td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="editarProducto('{{ producto.id }}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="eliminarProducto('{{ producto.id }}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Secci√≥n de Gesti√≥n de Empleados -->
    <div id="empleados" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gesti√≥n de Empleados</h2>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNuevoEmpleado">
          <i class="bi bi-plus-circle"></i> Nuevo Empleado
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Departamento</th>
              <th>Cargo</th>
              <th>Tel√©fono</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for empleado in empleados %}
            <tr>
              <td>{{ empleado.id }}</td>
              <td>{{ empleado.usuario.get_full_name }}</td>
              <td>{{ empleado.usuario.email }}</td>
              <td>{{ empleado.departamento }}</td>
              <td>{{ empleado.cargo }}</td>
              <td>{{ empleado.telefono }}</td>
              <td>
                {% if empleado.activo %}
                  <span class="badge bg-success">Activo</span>
                {% else %}
                  <span class="badge bg-danger">Inactivo</span>
                {% endif %}
              </td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="editarEmpleado('{{ empleado.id }}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="eliminarEmpleado('{{ empleado.id }}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Secci√≥n de Informe de Ventas -->
    <div id="ventas" class="section">
      <h2 class="mb-4">Informe de Ventas</h2>
      <ul class="nav nav-tabs" id="tabsInformes" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-mes" data-bs-toggle="tab" data-bs-target="#informe-mes" type="button" role="tab">Ventas por Mes</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-top" data-bs-toggle="tab" data-bs-target="#informe-top" type="button" role="tab">Top Productos</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-cat" data-bs-toggle="tab" data-bs-target="#informe-cat" type="button" role="tab">Por Categor√≠a</button>
        </li>
      </ul>
      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="informe-mes" role="tabpanel">
          <div class="d-flex align-items-center mb-2">
            <label class="me-2 mb-0">A√±o:</label>
            <select id="selectorAnio" class="form-select form-select-sm w-auto me-3"></select>
            <label class="me-2 mb-0">Mes:</label>
            <select id="selectorMes" class="form-select form-select-sm w-auto">
              <option value="0">Todos</option>
              <option value="1">Enero</option>
              <option value="2">Febrero</option>
              <option value="3">Marzo</option>
              <option value="4">Abril</option>
              <option value="5">Mayo</option>
              <option value="6">Junio</option>
              <option value="7">Julio</option>
              <option value="8">Agosto</option>
              <option value="9">Septiembre</option>
              <option value="10">Octubre</option>
              <option value="11">Noviembre</option>
              <option value="12">Diciembre</option>
            </select>
          </div>
          <canvas id="graficoVentasMes" width="150" height="90"></canvas>
          <div id="tablaVentasMes"></div>
        </div>
        <div class="tab-pane fade" id="informe-top" role="tabpanel">
          <h4>Top Productos Vendidos</h4>
          <ul class="list-group" id="topProductos"></ul>
        </div>
        <div class="tab-pane fade" id="informe-cat" role="tabpanel">
          <h4>Ventas por Categor√≠a</h4>
          <canvas id="graficoVentasCategoria" width="150" height="90"></canvas>
          <div id="tablaVentasCategoria"></div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Desempe√±o -->
    <div id="desempeno" class="section">
      <h2>Informe de Desempe√±o de la Tienda</h2>
      <form class="row g-3 mb-4">
        <div class="col-md-4">
          <label>Desde</label>
          <input type="date" class="form-control">
        </div>
        <div class="col-md-4">
          <label>Hasta</label>
          <input type="date" class="form-control">
        </div>
        <div class="col-md-4 align-self-end">
          <button class="btn btn-primary w-100">Generar</button>
        </div>
      </form>
    </div>

    <!-- Secci√≥n de Gesti√≥n de Ofertas -->
    <div id="ofertas" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gesti√≥n de Ofertas</h2>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Producto</th>
              <th>Categor√≠a</th>
              <th>Precio Actual</th>
              <th>Precio de Oferta</th>
              <th>Descuento</th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaOfertas">
            <!-- Los productos en oferta se cargar√°n din√°micamente aqu√≠ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Nueva secci√≥n de Pedidos -->
    <div id="pedidos" class="section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gesti√≥n de Pedidos</h2>
        <div>
          <button class="btn btn-outline-primary" onclick="cargarPedidos()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
          </button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="row mb-4">
        <div class="col-md-3">
          <select class="form-select" id="filtroEstado" onchange="filtrarPedidos()">
            <option value="">Todos los estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="confirmada">Confirmada</option>
            <option value="preparada">Preparada</option>
            <option value="enviada">Enviada</option>
            <option value="entregada">Entregada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" id="busquedaPedidos" placeholder="Buscar por cliente..." onkeyup="filtrarPedidos()">
        </div>
        <div class="col-md-3">
          <select class="form-select" id="ordenarPor" onchange="filtrarPedidos()">
            <option value="-fecha">M√°s recientes</option>
            <option value="fecha">M√°s antiguos</option>
            <option value="-total">Mayor total</option>
            <option value="total">Menor total</option>
            <option value="-prioridad">Mayor prioridad</option>
            <option value="prioridad">Menor prioridad</option>
          </select>
        </div>
      </div>

      <!-- Estad√≠sticas r√°pidas -->
      <div class="row mb-4">
        <div class="col-md-2">
          <div class="card bg-warning text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Pendientes</h5>
              <h3 id="contadorPendientes">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Confirmadas</h5>
              <h3 id="contadorConfirmadas">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Preparadas</h5>
              <h3 id="contadorPreparadas">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Enviadas</h5>
              <h3 id="contadorEnviadas">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Entregadas</h5>
              <h3 id="contadorEntregadas">0</h3>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-danger text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Canceladas</h5>
              <h3 id="contadorCanceladas">0</h3>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-md-2">
          <div class="card bg-secondary text-white">
            <div class="card-body text-center">
              <h5 class="card-title">Total</h5>
              <h3 id="contadorTotal">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de pedidos -->
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="tablaPedidos">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Prioridad</th>
              <th>Vendedor</th>
              <th>Bodeguero</th>
              <th>Preparaci√≥n</th>
              <th>Tiempo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for venta in ventas %}
            <tr data-estado="{{ venta.estado }}" data-cliente="{{ venta.cliente|lower }}" data-total="{{ venta.total }}" data-fecha="{{ venta.fecha }}" data-prioridad="{{ venta.prioridad }}">
              <td>
                <strong>#{{ venta.id }}</strong>
                {% if venta.prioridad == 'alta' %}
                  <span class="badge bg-danger ms-1">Alta</span>
                {% elif venta.prioridad == 'media' %}
                  <span class="badge bg-warning ms-1">Media</span>
                {% endif %}
              </td>
              <td>{{ venta.fecha }}</td>
              <td>
                <div>
                  <strong>{{ venta.cliente }}</strong>
                  <br>
                  <small class="text-muted">{{ venta.telefono }}</small>
                </div>
              </td>
              <td>
                <strong>${{ venta.total|floatformat:0 }}</strong>
              </td>
              <td>
                {% if venta.estado == 'pendiente' %}
                  <span class="badge bg-warning">Pendiente</span>
                {% elif venta.estado == 'confirmada' %}
                  <span class="badge bg-info">Confirmada</span>
                {% elif venta.estado == 'preparada' %}
                  <span class="badge bg-primary">Preparada</span>
                {% elif venta.estado == 'enviada' %}
                  <span class="badge bg-primary">Enviada</span>
                {% elif venta.estado == 'entregada' %}
                  <span class="badge bg-success">Entregada</span>
                {% elif venta.estado == 'cancelada' %}
                  <span class="badge bg-danger">Cancelada</span>
                {% endif %}
              </td>
              <td>
                {% if venta.prioridad == 'alta' %}
                  <span class="badge bg-danger">Alta</span>
                {% elif venta.prioridad == 'media' %}
                  <span class="badge bg-warning">Media</span>
                {% else %}
                  <span class="badge bg-secondary">Normal</span>
                {% endif %}
              </td>
              <td>
                {% if venta.aceptada_por %}
                  <div>
                    <strong>{{ venta.aceptada_por }}</strong>
                    <br>
                    <small class="text-muted">{{ venta.fecha_aceptacion }}</small>
                  </div>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if venta.preparado_por %}
                  <div>
                    <strong>{{ venta.preparado_por }}</strong>
                    <br>
                    <small class="text-muted">{{ venta.fecha_preparacion }}</small>
                  </div>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                <div class="progress" style="height: 20px;">
                  <div class="progress-bar" role="progressbar" 
                       style="width: {{ venta.estadisticas_preparacion.porcentaje_preparado }}%"
                       aria-valuenow="{{ venta.estadisticas_preparacion.porcentaje_preparado }}" 
                       aria-valuemin="0" aria-valuemax="100">
                    {{ venta.estadisticas_preparacion.productos_preparados }}/{{ venta.estadisticas_preparacion.total_productos }}
                  </div>
                </div>
                <small class="text-muted">{{ venta.estadisticas_preparacion.porcentaje_preparado }}%</small>
              </td>
              <td>
                {% if venta.horas_en_estado > 24 %}
                  <span class="badge bg-danger">{{ venta.horas_en_estado }}h</span>
                {% elif venta.horas_en_estado > 12 %}
                  <span class="badge bg-warning">{{ venta.horas_en_estado }}h</span>
                {% else %}
                  <span class="badge bg-success">{{ venta.horas_en_estado }}h</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-primary" onclick="verDetalleVenta({{ venta.id }})" title="Ver detalle">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-info" onclick="verUbicacion('{{ venta.direccion }}', '{{ venta.ciudad }}')" title="Ver ubicaci√≥n">
                    <i class="bi bi-geo-alt"></i>
                  </button>
                  {% if venta.estado == 'pendiente' %}
                    <button class="btn btn-sm btn-outline-success" onclick="cambiarEstado({{ venta.id }}, 'confirmada')" title="Confirmar">
                      <i class="bi bi-check-circle"></i>
                    </button>
                  {% elif venta.estado == 'confirmada' %}
                    <button class="btn btn-sm btn-outline-primary" onclick="cambiarEstado({{ venta.id }}, 'preparada')" title="Marcar como preparada">
                      <i class="bi bi-clipboard-check"></i>
                    </button>
                  {% elif venta.estado == 'preparada' %}
                    <button class="btn btn-sm btn-outline-primary" onclick="cambiarEstado({{ venta.id }}, 'enviada')" title="Marcar como enviada">
                      <i class="bi bi-truck"></i>
                    </button>
                  {% elif venta.estado == 'enviada' %}
                    <button class="btn btn-sm btn-outline-success" onclick="cambiarEstado({{ venta.id }}, 'entregada')" title="Marcar como entregada">
                      <i class="bi bi-box-seam"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mensaje si no hay pedidos -->
      {% if not ventas %}
      <div class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h4 class="text-muted mt-3">No hay pedidos registrados</h4>
        <p class="text-muted">Los pedidos aparecer√°n aqu√≠ cuando los clientes realicen compras.</p>
      </div>
      {% endif %}
    </div>

    <!-- Modal Nuevo Producto -->
    <div class="modal fade" id="modalNuevoProducto" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="{% url 'crear_producto' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">Nuevo Producto</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input type="text" name="nombre" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Categor√≠a</label>
                <select name="categoria" class="form-select" required>
                  <option value="">Seleccione una categor√≠a</option>
                  {% for categoria in categorias %}
                    <option value="{{ categoria.nombre }}">{{ categoria.nombre }}</option>
                  {% endfor %}
                </select>
                <div class="form-text">
                  <a href="#" data-bs-toggle="modal" data-bs-target="#modalNuevaCategoria">
                    <i class="bi bi-plus-circle"></i> Agregar nueva categor√≠a
                  </a>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Precio</label>
                <input type="number" name="precio" class="form-control" min="1" required 
                       onblur="validarNumeroPositivo(this)">
                <div class="invalid-feedback">El precio debe ser mayor a 0</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input type="number" name="stock" class="form-control" min="1" required 
                       onblur="validarNumeroPositivo(this)">
                <div class="invalid-feedback">El stock debe ser mayor a 0</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Descripci√≥n</label>
                <textarea name="descripcion" class="form-control" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Imagen</label>
                <input type="file" name="imagen" class="form-control" accept="image/*">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Nuevo Empleado -->
    <div class="modal fade" id="modalNuevoEmpleado" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="{% url 'crear_empleado' %}" method="POST">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">Nuevo Empleado</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Nombre Completo</label>
                <input type="text" name="nombre" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Departamento</label>
                <select name="departamento" class="form-select" required>
                  <option value="ventas">Ventas</option>
                  <option value="bodega">Bodega</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Cargo</label>
                <input type="text" name="cargo" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Tel√©fono</label>
                <input type="tel" name="telefono" class="form-control" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Nueva Categor√≠a -->
    <div class="modal fade" id="modalNuevaCategoria" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="{% url 'crear_categoria' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">Nueva Categor√≠a</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input type="text" name="nombre" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Descripci√≥n</label>
                <textarea name="descripcion" class="form-control" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Imagen</label>
                <input type="file" name="imagen" class="form-control" accept="image/*">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Detalle de Venta -->
    <div class="modal fade" id="modalDetalleVenta" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalle del Pedido</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="detalleVentaContenido">
            <!-- El contenido se cargar√° din√°micamente -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Producto -->
    <div class="modal fade" id="editarProductoModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <form id="editarProductoForm" method="POST">
            {% csrf_token %}
            <div class="modal-body">
              <input type="hidden" name="id" id="editProductoId">
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input type="text" name="nombre" id="edit_nombre" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Categor√≠a</label>
                <select name="categoria" id="edit_categoria" class="form-select" required>
                  {% for categoria in categorias %}
                    <option value="{{ categoria.nombre }}">{{ categoria.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Precio Actual ($)</label>
                <input type="number" name="precio" id="edit_precio" class="form-control" min="1" required onblur="validarNumeroPositivo(this)">
              </div>
              <div class="mb-3">
                <label class="form-label">Precio de Oferta ($) - Opcional</label>
                <input type="number" name="precio_oferta" id="edit_precio_oferta" class="form-control" min="1" onblur="validarPrecioOferta(this)">
                <div class="form-text">Dejar vac√≠o para quitar la oferta. Debe ser menor al precio actual.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input type="number" name="stock" id="edit_stock" class="form-control" min="0" required onblur="validarNumeroPositivo(this)">
              </div>
              <div class="mb-3">
                <label class="form-label">Descripci√≥n</label>
                <textarea name="descripcion" id="edit_descripcion" class="form-control" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Imagen</label>
                <div id="edit_imagen_actual" class="mb-2"></div>
                <input type="file" name="imagen" class="form-control" accept="image/*">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Editar Empleado -->
    <div class="modal fade" id="modalEditarEmpleado" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formEditarEmpleado" method="POST">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">Editar Empleado</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="empleado_id" id="edit_empleado_id">
              <div class="mb-3">
                <label class="form-label">Nombre Completo</label>
                <input type="text" name="nombre" id="edit_nombre" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" name="email" id="edit_email" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Departamento</label>
                <select name="departamento" id="edit_departamento" class="form-select" required>
                  <option value="ventas">Ventas</option>
                  <option value="bodega">Bodega</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Cargo</label>
                <input type="text" name="cargo" id="edit_cargo" class="form-control" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Tel√©fono</label>
                <input type="tel" name="telefono" id="edit_telefono" class="form-control" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para ver detalles de venta -->
    <div class="modal fade" id="modalDetalleVenta" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalle de la Venta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="detalleVentaContenido"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Funciones de gesti√≥n
      function editarProducto(id) {
        // Obtener los datos del producto mediante AJAX
        fetch(`/panel/productos/obtener/${id}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const producto = data.producto;
              // Llenar el formulario con los datos del producto
              document.getElementById('editProductoId').value = producto.id;
              document.getElementById('edit_nombre').value = producto.nombre;
              document.getElementById('edit_categoria').value = producto.categoria;
              document.getElementById('edit_precio').value = producto.precio;
              document.getElementById('edit_precio_oferta').value = producto.precio_oferta || '';
              document.getElementById('edit_stock').value = producto.stock;
              document.getElementById('edit_descripcion').value = producto.descripcion;
              
              // Mostrar la imagen actual si existe
              const imagenContainer = document.getElementById('edit_imagen_actual');
              if (producto.imagen) {
                imagenContainer.innerHTML = `
                  <img src="${producto.imagen}" alt="${producto.nombre}" 
                       style="max-width: 200px; max-height: 200px;" class="img-thumbnail">
                `;
              } else {
                imagenContainer.innerHTML = '<p class="text-muted">No hay imagen</p>';
              }

              // Actualizar la acci√≥n del formulario
              document.getElementById('editarProductoForm').action = `/panel/productos/editar/${id}/`;
              
              // Mostrar el modal
              const modal = new bootstrap.Modal(document.getElementById('editarProductoModal'));
              modal.show();
            } else {
              alert('Error al cargar los datos del producto');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del producto');
          });
      }

      function validarPrecioOferta(input) {
        const precioActual = document.getElementById('edit_precio').value;
        const precioOferta = input.value;
        
        if (precioOferta && precioActual) {
          if (parseFloat(precioOferta) <= 0) {
            input.classList.add('is-invalid');
            input.nextElementSibling.textContent = 'El precio de oferta debe ser mayor a 0';
            return false;
          }
          if (parseFloat(precioOferta) >= parseFloat(precioActual)) {
            input.classList.add('is-invalid');
            input.nextElementSibling.textContent = 'El precio de oferta debe ser menor al precio actual';
            return false;
          }
        }
        
        input.classList.remove('is-invalid');
        return true;
      }

      // Manejar el env√≠o del formulario de edici√≥n
      document.getElementById('editarProductoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validar campos antes de enviar
        const precio = document.getElementById('edit_precio');
        const stock = document.getElementById('edit_stock');
        const precioOferta = document.getElementById('edit_precio_oferta');
        
        if (!validarNumeroPositivo(precio) || !validarNumeroPositivo(stock)) {
          alert('Por favor, ingrese valores v√°lidos mayores a 0 para precio y stock');
          return;
        }
        
        if (precioOferta.value && !validarPrecioOferta(precioOferta)) {
          alert('Por favor, corrija el precio de oferta');
          return;
        }
        
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editarProductoModal'));
            modal.hide();
            // Mostrar mensaje de √©xito
            Swal.fire({
              title: '¬°√âxito!',
              text: 'Producto actualizado correctamente',
              icon: 'success',
              timer: 1500,
              timerProgressBar: true,
              showConfirmButton: false
            }).then(() => {
              // Recargar la p√°gina para mostrar los cambios
              window.location.reload();
            });
          } else if (data.error) {
            Swal.fire({
              title: 'Error',
              text: data.error,
              icon: 'error'
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire({
            title: 'Error',
            text: 'Error al guardar los cambios',
            icon: 'error'
          });
        });
      });

      function eliminarProducto(id) {
        Swal.fire({
          title: '¬øEliminar Producto?',
          text: '¬øEst√°s seguro de que deseas eliminar este producto?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'S√≠, eliminar',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = `/panel/productos/eliminar/${id}/`;
          }
        });
      }

      function editarEmpleado(id) {
        // Obtener los datos del empleado mediante AJAX
        fetch(`/panel/empleados/obtener/${id}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const empleado = data.empleado;
              // Llenar el formulario con los datos del empleado
              document.getElementById('edit_empleado_id').value = empleado.id;
              document.getElementById('edit_nombre').value = empleado.nombre;
              document.getElementById('edit_email').value = empleado.email;
              document.getElementById('edit_departamento').value = empleado.departamento;
              document.getElementById('edit_cargo').value = empleado.cargo;
              document.getElementById('edit_telefono').value = empleado.telefono;

              // Actualizar la acci√≥n del formulario
              document.getElementById('formEditarEmpleado').action = `/panel/empleados/editar/${id}/`;
              
              // Mostrar el modal
              const modal = new bootstrap.Modal(document.getElementById('modalEditarEmpleado'));
              modal.show();
            } else {
              alert('Error al cargar los datos del empleado');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del empleado');
          });
      }

      // Manejar el env√≠o del formulario de edici√≥n de empleado
      document.getElementById('formEditarEmpleado').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarEmpleado'));
            modal.hide();
            // Mostrar mensaje de √©xito
            Swal.fire({
              title: '¬°√âxito!',
              text: 'Empleado actualizado correctamente',
              icon: 'success',
              timer: 1500,
              timerProgressBar: true,
              showConfirmButton: false
            }).then(() => {
              // Recargar la p√°gina para mostrar los cambios
              window.location.reload();
            });
          } else if (data.error) {
            Swal.fire({
              title: 'Error',
              text: data.error,
              icon: 'error'
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire({
            title: 'Error',
            text: 'Error al guardar los cambios',
            icon: 'error'
          });
        });
      });

      function eliminarEmpleado(id) {
        Swal.fire({
          title: '¬øEliminar Empleado?',
          text: '¬øEst√°s seguro de que deseas eliminar este empleado?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'S√≠, eliminar',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = `/panel/empleados/eliminar/${id}/`;
          }
        });
      }

      // Manejo de mensajes de Django
      document.addEventListener('DOMContentLoaded', function() {
        const messages = document.querySelectorAll('.alert');
        messages.forEach(function(message) {
          setTimeout(function() {
            message.style.display = 'none';
          }, 5000);
        });
      });
    </script>

    <!-- Mensajes de Django -->
    {% if messages %}
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <script>
      function showSection(id) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (id === 'ventas') cargarReporteVentas();
      }
    </script>

    <!-- Bootstrap Bundle con Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Funci√≥n para actualizar el select de categor√≠as despu√©s de crear una nueva
      function actualizarCategorias(nuevaCategoria) {
        const select = document.querySelector('select[name="categoria"]');
        const option = document.createElement('option');
        option.value = nuevaCategoria.nombre;
        option.textContent = nuevaCategoria.nombre;
        select.appendChild(option);
        select.value = nuevaCategoria.nombre;
      }

      // Manejar el env√≠o del formulario de categor√≠a
      document.querySelector('#modalNuevaCategoria form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const modal = document.getElementById('modalNuevaCategoria');
        
        fetch('{% url "crear_categoria" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            actualizarCategorias(data.categoria);
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
              bsModal.hide();
            }
            // Mostrar mensaje de √©xito
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
              ${data.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.content').prepend(alert);
            // Limpiar el formulario
            this.reset();
          } else {
            throw new Error(data.message || 'Error al crear la categor√≠a');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          // Mostrar mensaje de error
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger alert-dismissible fade show';
          alert.innerHTML = `
            ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.querySelector('.content').prepend(alert);
        });
      });
    </script>

    <script>
      // Funci√≥n para validar n√∫meros positivos
      function validarNumeroPositivo(input) {
        // Solo validar si el campo tiene un valor
        if (input.value.trim() === '') {
          input.classList.remove('is-invalid');
          return true;
        }

        const value = parseInt(input.value);
        if (isNaN(value) || value <= 0) {
          input.classList.add('is-invalid');
          return false;
        }
        input.classList.remove('is-invalid');
        return true;
      }

      // Validar formularios antes de enviar
      document.querySelector('#modalNuevoProducto form').addEventListener('submit', function(e) {
        const precio = this.querySelector('input[name="precio"]');
        const stock = this.querySelector('input[name="stock"]');
        
        if (!validarNumeroPositivo(precio) || !validarNumeroPositivo(stock)) {
          e.preventDefault();
          Swal.fire({
            title: 'Validaci√≥n',
            text: 'Por favor, ingrese valores v√°lidos mayores a 0',
            icon: 'warning'
          });
        }
      });

      document.querySelector('#editarProductoForm').addEventListener('submit', function(e) {
        const precio = this.querySelector('input[name="precio"]');
        const stock = this.querySelector('input[name="stock"]');
        
        if (!validarNumeroPositivo(precio) || !validarNumeroPositivo(stock)) {
          e.preventDefault();
          Swal.fire({
            title: 'Validaci√≥n',
            text: 'Por favor, ingrese valores v√°lidos mayores a 0',
            icon: 'warning'
          });
        }
      });
    </script>

    <script>
      function cargarOfertas() {
        fetch('/panel/productos/ofertas/')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const tbody = document.getElementById('tablaOfertas');
              tbody.innerHTML = '';
              
              data.productos.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>
                    <div class="d-flex align-items-center">
                      ${producto.imagen ? 
                        `<img src="${producto.imagen}" alt="${producto.nombre}" class="me-2" style="width: 40px; height: 40px; object-fit: cover;">` :
                        `<i class="bi bi-box me-2" style="font-size: 1.5rem;"></i>`
                      }
                      ${producto.nombre}
                    </div>
                  </td>
                  <td>${producto.categoria}</td>
                  <td><del>$${producto.precio.toLocaleString()}</del></td>
                  <td class="text-danger fw-bold">$${producto.precio_oferta.toLocaleString()}</td>
                  <td><span class="badge bg-danger">-${producto.descuento}%</span></td>
                  <td>${producto.stock}</td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editarProducto(${producto.id})">
                      <i class="bi bi-pencil"></i> Editar
                    </button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            }
          })
          .catch(error => console.error('Error:', error));
      }

      // Cargar ofertas cuando se muestra la secci√≥n
      document.querySelector('a[onclick="showSection(\'ofertas\')"]').addEventListener('click', cargarOfertas);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // --- ORDENAMIENTO TABLAS INFORMES DE VENTAS ---
    function ordenarTablaHtml(tablaId, colIndex, tipo = 'string', asc = true) {
      const tabla = document.getElementById(tablaId);
      if (!tabla) return;
      const tbody = tabla.querySelector('tbody');
      const filas = Array.from(tbody.querySelectorAll('tr'));
      filas.sort((a, b) => {
        let valA = a.children[colIndex].textContent.trim();
        let valB = b.children[colIndex].textContent.trim();
        if (tipo === 'number') {
          valA = parseFloat(valA.replace(/[^\d.-]/g, ''));
          valB = parseFloat(valB.replace(/[^\d.-]/g, ''));
        }
        if (asc) {
          return valA > valB ? 1 : valA < valB ? -1 : 0;
        } else {
          return valA < valB ? 1 : valA > valB ? -1 : 0;
        }
      });
      filas.forEach(fila => tbody.appendChild(fila));
    }

    function agregarOrdenamientoTabla(tablaId, tiposCol) {
      const tabla = document.getElementById(tablaId);
      if (!tabla) return;
      const ths = tabla.querySelectorAll('thead th');
      ths.forEach((th, idx) => {
        let asc = true;
        th.style.cursor = 'pointer';
        th.innerHTML += ' <span class="ordenar-flecha"></span>';
        th.onclick = function() {
          ths.forEach((oth, i) => {
            if (i !== idx) oth.querySelector('.ordenar-flecha').textContent = '';
          });
          asc = !asc;
          ordenarTablaHtml(tablaId, idx, tiposCol[idx], asc);
          th.querySelector('.ordenar-flecha').textContent = asc ? '‚Üë' : '‚Üì';
        };
      });
    }

    function cargarReporteVentas() {
      const anio = document.getElementById('selectorAnio').value;
      const mes = document.getElementById('selectorMes').value;
      let url = `/api/ventas/reportes/?tipo=mensual&anio=${anio}`;
      if (mes !== "0") {
        url = `/api/ventas/reportes/?tipo=diario&anio=${anio}&mes=${mes}`;
      }
      fetch(url)
        .then(res => res.json())
        .then(data => {
          let labels, valores, labelEje;
          if (mes === "0") {
            labels = data.data.map(item => `Mes ${item.mes}`);
            valores = data.data.map(item => item.total);
            labelEje = 'Ventas CLP por Mes';
          } else {
            labels = data.data.map(item => `D√≠a ${item.dia}`);
            valores = data.data.map(item => item.total);
            labelEje = 'Ventas CLP por D√≠a';
          }
          // Limpiar el canvas y destruir el gr√°fico anterior
          const canvas = document.getElementById('graficoVentasMes');
          canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
          if (window.graficoVentasMes && typeof window.graficoVentasMes.destroy === 'function') {
            window.graficoVentasMes.destroy();
            window.graficoVentasMes = null;
          }
          // Solo crear el gr√°fico si hay datos
          if (labels.length > 0) {
            window.graficoVentasMes = new Chart(canvas, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: labelEje,
                  data: valores,
                  backgroundColor: 'rgba(13, 110, 253, 0.5)'
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false } }
              }
            });
          }
          let tabla = `<table class="table table-sm mt-3" id="tablaVentasMesTable"><thead><tr><th>${mes === "0" ? "Mes" : "D√≠a"}</th><th>Total Ventas</th></tr></thead><tbody>`;
          data.data.forEach(item => {
            tabla += `<tr><td>${mes === "0" ? item.mes : item.dia}</td><td>$${item.total}</td></tr>`;
          });
          tabla += '</tbody></table>';
          document.getElementById('tablaVentasMes').innerHTML = tabla;
          // Agrego ordenamiento a la tabla de ventas por mes/d√≠a
          setTimeout(() => agregarOrdenamientoTabla('tablaVentasMesTable', ['string','number']), 100);
          cargarVentasPorCategoria();
        });
      fetch('/api/ventas/top-productos/?limite=5')
        .then(res => res.json())
        .then(data => {
          let html = '';
          data.top_productos.forEach((prod, idx) => {
            html += `<li class="list-group-item d-flex justify-content-between align-items-center">
              ${idx+1}. ${prod.producto__nombre}
              <span class="badge bg-primary rounded-pill">${prod.cantidad}</span>
            </li>`;
          });
          document.getElementById('topProductos').innerHTML = html;
        });
    }
    function llenarSelectorAnios() {
      const selector = document.getElementById('selectorAnio');
      const anioActual = new Date().getFullYear();
      for (let i = anioActual; i >= anioActual - 5; i--) {
        selector.innerHTML += `<option value="${i}">${i}</option>`;
      }
      selector.value = anioActual;
    }
    document.addEventListener('DOMContentLoaded', function() {
      llenarSelectorAnios();
      document.getElementById('selectorAnio').addEventListener('change', cargarReporteVentas);
      document.getElementById('selectorMes').addEventListener('change', cargarReporteVentas);
    });
    </script>

    <script>
      function cargarVentasPorCategoria() {
        const anio = document.getElementById('selectorAnio').value;
        const mes = document.getElementById('selectorMes').value;
        let url = `/api/ventas/por-categoria/?anio=${anio}`;
        if (mes !== "0") url += `&mes=${mes}`;
        fetch(url)
          .then(res => res.json())
          .then(data => {
            const labels = data.ventas_por_categoria.map(item => item['producto__categoria__nombre']);
            const valores = data.ventas_por_categoria.map(item => item.total);
            // Limpiar y destruir gr√°fico anterior
            const canvas = document.getElementById('graficoVentasCategoria');
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            if (window.graficoVentasCategoria && typeof window.graficoVentasCategoria.destroy === 'function') {
              window.graficoVentasCategoria.destroy();
              window.graficoVentasCategoria = null;
            }
            if (labels.length > 0) {
              window.graficoVentasCategoria = new Chart(canvas, {
                type: 'pie',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'Ventas por Categor√≠a',
                    data: valores,
                    backgroundColor: [
                      'rgba(13, 110, 253, 0.5)',
                      'rgba(40, 167, 69, 0.5)',
                      'rgba(255, 193, 7, 0.5)',
                      'rgba(220, 53, 69, 0.5)',
                      'rgba(23, 162, 184, 0.5)',
                      'rgba(108, 117, 125, 0.5)'
                    ]
                  }]
                },
                options: {
                  responsive: true
                }
              });
            }
            let tabla = `<table class="table table-sm mt-3" id="tablaVentasCategoriaTable"><thead><tr><th>Categor√≠a</th><th>Total Ventas</th></tr></thead><tbody>`;
            data.ventas_por_categoria.forEach(item => {
              tabla += `<tr><td>${item['producto__categoria__nombre']}</td><td>$${item.total}</td></tr>`;
            });
            tabla += '</tbody></table>';
            document.getElementById('tablaVentasCategoria').innerHTML = tabla;
            // Agrego ordenamiento a la tabla de ventas por categor√≠a
            setTimeout(() => agregarOrdenamientoTabla('tablaVentasCategoriaTable', ['string','number']), 100);
          });
      }
    </script>

    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
      function confirmarLogout() {
        Swal.fire({
          title: '¬øCerrar Sesi√≥n?',
          text: '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'S√≠, cerrar sesi√≥n',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            // Redirigir al logout
            window.location.href = '/logout/';
          }
        });
      }
    </script>

    <script>
      // Funciones para la gesti√≥n de pedidos
      function cargarPedidos() {
        location.reload();
      }

      function filtrarPedidos() {
        const filtroEstado = document.getElementById('filtroEstado').value;
        const busqueda = document.getElementById('busquedaPedidos').value.toLowerCase();
        const ordenarPor = document.getElementById('ordenarPor').value;
        
        const filas = document.querySelectorAll('#tablaPedidos tbody tr');
        let contadores = {
          pendiente: 0,
          confirmada: 0,
          preparada: 0,
          enviada: 0,
          entregada: 0,
          cancelada: 0,
          total: 0
        };

        // Convertir NodeList a Array para poder ordenar
        let filasArray = Array.from(filas);
        
        // Aplicar filtros y recopilar datos para ordenamiento
        filasArray.forEach(fila => {
          const estado = fila.getAttribute('data-estado');
          const cliente = fila.getAttribute('data-cliente');
          
          let mostrar = true;
          
          // Aplicar filtro de estado
          if (filtroEstado && estado !== filtroEstado) {
            mostrar = false;
          }
          
          // Aplicar filtro de b√∫squeda
          if (busqueda && !cliente.includes(busqueda)) {
            mostrar = false;
          }
          
          if (mostrar) {
            fila.style.display = '';
            contadores[estado]++;
            contadores.total++;
          } else {
            fila.style.display = 'none';
          }
        });

        // Aplicar ordenamiento solo a las filas visibles
        const filasVisibles = filasArray.filter(fila => fila.style.display !== 'none');
        
        if (ordenarPor && filasVisibles.length > 0) {
          filasVisibles.sort((a, b) => {
            let valorA, valorB;
            
            switch (ordenarPor) {
              case '-fecha':
                // Ordenar por fecha (m√°s recientes primero)
                const fechaA = new Date(a.getAttribute('data-fecha'));
                const fechaB = new Date(b.getAttribute('data-fecha'));
                return fechaB - fechaA;
                
              case 'fecha':
                // Ordenar por fecha (m√°s antiguos primero)
                const fechaA2 = new Date(a.getAttribute('data-fecha'));
                const fechaB2 = new Date(b.getAttribute('data-fecha'));
                return fechaA2 - fechaB2;
                
              case '-total':
                // Ordenar por total (mayor a menor)
                valorA = parseInt(a.getAttribute('data-total'));
                valorB = parseInt(b.getAttribute('data-total'));
                return valorB - valorA;
                
              case 'total':
                // Ordenar por total (menor a mayor)
                valorA = parseInt(a.getAttribute('data-total'));
                valorB = parseInt(b.getAttribute('data-total'));
                return valorA - valorB;
                
              case '-prioridad':
                // Ordenar por prioridad (alta, media, normal)
                const prioridadA = getPrioridadValue(a.getAttribute('data-prioridad'));
                const prioridadB = getPrioridadValue(b.getAttribute('data-prioridad'));
                return prioridadB - prioridadA;
                
              case 'prioridad':
                // Ordenar por prioridad (normal, media, alta)
                const prioridadA2 = getPrioridadValue(a.getAttribute('data-prioridad'));
                const prioridadB2 = getPrioridadValue(b.getAttribute('data-prioridad'));
                return prioridadA2 - prioridadB2;
                
              default:
                return 0;
            }
          });
          
          // Reordenar las filas en el DOM
          const tbody = document.querySelector('#tablaPedidos tbody');
          filasVisibles.forEach(fila => {
            tbody.appendChild(fila);
          });
        }

        // Actualizar contadores
        document.getElementById('contadorPendientes').textContent = contadores.pendiente;
        document.getElementById('contadorConfirmadas').textContent = contadores.confirmada;
        document.getElementById('contadorPreparadas').textContent = contadores.preparada;
        document.getElementById('contadorEnviadas').textContent = contadores.enviada;
        document.getElementById('contadorEntregadas').textContent = contadores.entregada;
        document.getElementById('contadorCanceladas').textContent = contadores.cancelada;
        document.getElementById('contadorTotal').textContent = contadores.total;
      }

      // Funci√≥n auxiliar para obtener valor num√©rico de prioridad
      function getPrioridadValue(prioridadText) {
        if (prioridadText === 'alta') return 3;
        if (prioridadText === 'media') return 2;
        return 1; // normal
      }

      function cambiarEstado(ventaId, nuevoEstado) {
        let mensaje = '';
        let icono = 'question';
        switch (nuevoEstado) {
          case 'confirmada':
            mensaje = '¬øEst√°s seguro de que deseas confirmar este pedido?';
            icono = 'info';
            break;
          case 'preparada':
            mensaje = '¬øMarcar este pedido como PREPARADO? Esto indica que todos los productos est√°n listos.';
            icono = 'success';
            break;
          case 'enviada':
            mensaje = '¬øMarcar este pedido como ENVIADO? El pedido pasar√° a reparto.';
            icono = 'primary';
            break;
          case 'entregada':
            mensaje = '¬øMarcar este pedido como ENTREGADO al cliente?';
            icono = 'success';
            break;
          default:
            mensaje = `¬øEst√°s seguro de que deseas cambiar el estado a "${nuevoEstado}"?`;
        }
        Swal.fire({
          title: 'Confirmar acci√≥n',
          text: mensaje,
          icon: icono,
          showCancelButton: true,
          confirmButtonText: 'S√≠, continuar',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#0d6efd',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/actualizar-estado-pedido-admin/${ventaId}/`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: JSON.stringify({
                estado: nuevoEstado
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Estado actualizado',
                  text: 'El estado del pedido se ha actualizado correctamente'
                }).then(() => {
                  location.reload();
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.message || 'Error al actualizar el estado'
                });
              }
            })
            .catch(error => {
              console.error('Error:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error de conexi√≥n al actualizar el estado'
              });
            });
          }
        });
      }

      function verUbicacion(direccion, ciudad) {
        const direccionCompleta = `${direccion}, ${ciudad}`;
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(direccionCompleta)}`;
        window.open(url, '_blank');
      }

      function verDetalleVenta(ventaId) {
        fetch(`/obtener-detalle-pedido/${ventaId}/`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const venta = data.venta;
              let html = `
                <div class="mb-3">
                  <h6>Informaci√≥n del Cliente</h6>
                  <p><strong>Cliente:</strong> ${venta.cliente}</p>
                  <p><strong>Direcci√≥n:</strong> ${venta.direccion_entrega}</p>
                  <p><strong>Ciudad:</strong> ${venta.ciudad}</p>
                  <p><strong>Tel√©fono:</strong> ${venta.telefono_contacto}</p>
                </div>
                <div class="mb-3">
                  <h6>Informaci√≥n de la Venta</h6>
                  <p><strong>Estado actual:</strong> ${venta.estado}</p>
                  <p><strong>Fecha de venta:</strong> ${venta.fecha}</p>
                  <p><strong>Vendedor que acept√≥:</strong> ${venta.aceptada_por || '-'} ${venta.fecha_aceptacion ? '(' + venta.fecha_aceptacion + ')' : ''}</p>
                  ${venta.fecha_preparacion ? `<p><strong>Fecha de preparaci√≥n:</strong> ${venta.fecha_preparacion}</p>` : ''}
                  <p><strong>Notas:</strong> ${venta.notas || 'Sin notas'}</p>
                </div>
                <div class="mb-3">
                  <h6>Productos</h6>
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unit.</th>
                        <th>Subtotal</th>
                        <th>Estado</th>
                        <th>Preparado por</th>
                        <th>Fecha preparaci√≥n</th>
                        <th>Notas</th>
                      </tr>
                    </thead>
                    <tbody>
            `;
              venta.detalles.forEach(detalle => {
                html += `
                  <tr>
                    <td>
                      <img src="${detalle.producto.imagen_url || '/static/img/no-image.png'}" alt="${detalle.producto.nombre}" style="height:40px;width:40px;object-fit:contain;vertical-align:middle;margin-right:5px;">
                      ${detalle.producto.nombre}
                    </td>
                    <td>${detalle.cantidad}</td>
                    <td>$${detalle.precio_unitario}</td>
                    <td>$${detalle.subtotal}</td>
                    <td>
                      ${detalle.preparado ? '<span class="badge bg-success">Preparado</span>' : '<span class="badge bg-warning">Pendiente</span>'}
                    </td>
                    <td>${detalle.preparado_por || '-'}</td>
                    <td>${detalle.fecha_preparacion || '-'}</td>
                    <td>${detalle.notas_preparacion || '-'}</td>
                  </tr>
                `;
              });
              html += `
                    </tbody>
                  </table>
                </div>
                <div class="mb-3">
                  <h6>Informaci√≥n Adicional</h6>
                  <p><strong>Total:</strong> $${venta.total}</p>
                </div>
              `;
              document.getElementById('detalleVentaContenido').innerHTML = html;
              new bootstrap.Modal(document.getElementById('modalDetalleVenta')).show();
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar el detalle de la venta');
          });
      }

      // Inicializar contadores al cargar la p√°gina
      document.addEventListener('DOMContentLoaded', function() {
        filtrarPedidos();
      });
    </script>
</body>
</html>
